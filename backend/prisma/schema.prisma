generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model CustomerBank {
  id                   String                    @id @default(uuid()) @db.Char(36)
  bankCode             String                    @unique @map("bank_code") @db.VarChar(20)
  bankName             String                    @map("bank_name") @db.VarChar(255)
  status               OrganizationStatus        @default(ACTIVE)
  primaryContactName   String?                   @map("primary_contact_name") @db.VarChar(255)
  primaryContactEmail  String?                   @map("primary_contact_email") @db.VarChar(255)
  primaryContactPhone  String?                   @map("primary_contact_phone") @db.VarChar(50)
  createdAt            DateTime                  @default(now()) @map("created_at")
  updatedAt            DateTime                  @updatedAt @map("updated_at")
  pengelolaAssignments BankPengelolaAssignment[]
  cassettes            Cassette[]
  machines             Machine[]
  warrantyConfigurations WarrantyConfiguration[]

  @@map("customers_banks")
}

model Pengelola {
  id                         String                    @id @default(uuid()) @db.Char(36)
  pengelolaCode              String                    @unique @map("pengelola_code") @db.VarChar(50)
  companyName                String                    @map("company_name") @db.VarChar(255)
  companyAbbreviation        String                    @map("company_abbreviation") @db.VarChar(50)
  businessRegistrationNumber String?                   @map("business_registration_number") @db.VarChar(100)
  address                    String?
  city                       String?                   @db.VarChar(100)
  province                   String?                   @db.VarChar(100)
  primaryContactName         String?                   @map("primary_contact_name") @db.VarChar(255)
  primaryContactEmail        String?                   @map("primary_contact_email") @db.VarChar(255)
  primaryContactPhone        String?                   @map("primary_contact_phone") @db.VarChar(50)
  website                    String?                   @db.VarChar(255)
  status                     OrganizationStatus        @default(ACTIVE)
  notes                      String?
  createdAt                  DateTime                  @default(now()) @map("created_at")
  updatedAt                  DateTime                  @updatedAt @map("updated_at")
  bankAssignments            BankPengelolaAssignment[]
  machines                   Machine[]
  users                      PengelolaUser[]

  @@map("pengelola")
}

model BankPengelolaAssignment {
  id                     String             @id @default(uuid()) @db.Char(36)
  customerBankId         String             @map("customer_bank_id") @db.Char(36)
  pengelolaId            String             @map("pengelola_id") @db.Char(36)
  contractNumber         String?            @map("contract_number") @db.VarChar(100)
  contractStartDate      DateTime?          @map("contract_start_date") @db.Date
  contractEndDate        DateTime?          @map("contract_end_date") @db.Date
  serviceScope           String?            @map("service_scope")
  assignedBranches       Json?              @map("assigned_branches")
  slaResponseTimeHours   Int?               @map("sla_response_time_hours")
  slaResolutionTimeHours Int?               @map("sla_resolution_time_hours")
  status                 OrganizationStatus @default(ACTIVE)
  notes                  String?
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")
  customerBank           CustomerBank       @relation(fields: [customerBankId], references: [id], onDelete: Cascade)
  pengelola              Pengelola          @relation(fields: [pengelolaId], references: [id], onDelete: Cascade)

  @@unique([customerBankId, pengelolaId])
  @@map("bank_pengelola_assignments")
}

model PengelolaUser {
  id                 String                  @id @default(uuid()) @db.Char(36)
  pengelolaId        String                  @map("pengelola_id") @db.Char(36)
  username           String                  @unique @db.VarChar(100)
  email              String                  @unique @db.VarChar(255)
  passwordHash       String                  @map("password_hash") @db.VarChar(255)
  fullName           String                  @map("full_name") @db.VarChar(255)
  phone              String?                 @db.VarChar(50)
  whatsappNumber     String?                 @map("whatsapp_number") @db.VarChar(50)
  role               PengelolaUserRole       @default(TECHNICIAN)
  employeeId         String?                 @map("employee_id") @db.VarChar(100)
  canCreateTickets   Boolean                 @default(true) @map("can_create_tickets")
  canCloseTickets    Boolean                 @default(false) @map("can_close_tickets")
  canManageMachines  Boolean                 @default(false) @map("can_manage_machines")
  assignedBranches   Json?                   @map("assigned_branches")
  status             OrganizationStatus      @default(ACTIVE)
  lastLogin          DateTime?               @map("last_login")
  createdAt          DateTime                @default(now()) @map("created_at")
  updatedAt          DateTime                @updatedAt @map("updated_at")
  cassetteDeliveries CassetteDelivery[]
  receivedReturns    CassetteReturn[]        @relation("ReturnReceiver")
  problemTickets     ProblemTicket[]
  requestedPMs       PreventiveMaintenance[] @relation("PMRequesterPengelola")
  pengelola          Pengelola               @relation(fields: [pengelolaId], references: [id], onDelete: Cascade)

  @@map("pengelola_users")
}

model HitachiUser {
  id                 String                  @id @default(uuid()) @db.Char(36)
  username           String                  @unique @db.VarChar(100)
  email              String                  @unique @db.VarChar(255)
  passwordHash       String                  @map("password_hash") @db.VarChar(255)
  fullName           String                  @map("full_name") @db.VarChar(255)
  role               HitachiUserRole         @default(RC_STAFF)
  department         HitachiUserDepartment   @default(REPAIR_CENTER)
  status             OrganizationStatus      @default(ACTIVE)
  lastLogin          DateTime?               @map("last_login")
  createdAt          DateTime                @default(now()) @map("created_at")
  updatedAt          DateTime                @updatedAt @map("updated_at")
  receivedDeliveries CassetteDelivery[]      @relation("DeliveryReceiver")
  sentReturns        CassetteReturn[]        @relation("ReturnSender")
  repairTickets      RepairTicket[]
  assignedPMs        PreventiveMaintenance[] @relation("PMEngineer")
  requestedPMs       PreventiveMaintenance[] @relation("PMRequesterHitachi")
  cancelledPMs       PreventiveMaintenance[] @relation("PMCanceller")
  completedPMs       PreventiveMaintenance[] @relation("PMCompleter")
  deletedPMs         PreventiveMaintenance[] @relation("PMDeleter")
  deletedRepairTickets RepairTicket[]       @relation("RepairTicketDeleter")

  @@map("hitachi_users")
}

model Machine {
  id                       String                     @id @default(uuid()) @db.Char(36)
  customerBankId           String                     @map("customer_bank_id") @db.Char(36)
  pengelolaId              String                     @map("pengelola_id") @db.Char(36)
  machineCode              String                     @unique @map("machine_code") @db.VarChar(100)
  modelName                String                     @map("model_name") @db.VarChar(255)
  serialNumberManufacturer String                     @map("serial_number_manufacturer") @db.VarChar(255)
  physicalLocation         String                     @map("physical_location")
  branchCode               String?                    @map("branch_code") @db.VarChar(100)
  city                     String?                    @db.VarChar(100)
  province                 String?                    @db.VarChar(100)
  installationDate         DateTime?                  @map("installation_date") @db.Date
  currentWsid              String?                    @map("current_wsid") @db.VarChar(100)
  status                   MachineStatus              @default(OPERATIONAL)
  notes                    String?
  createdAt                DateTime                   @default(now()) @map("created_at")
  updatedAt                DateTime                   @updatedAt @map("updated_at")
  identifierHistory        MachineIdentifierHistory[]
  customerBank             CustomerBank               @relation(fields: [customerBankId], references: [id])
  pengelola                Pengelola                  @relation(fields: [pengelolaId], references: [id])
  problemTickets           ProblemTicket[]
  cassettes                Cassette[]

  @@index([customerBankId]) // Filter by bank
  @@index([pengelolaId]) // Filter by pengelola
  @@index([status]) // Filter by status
  @@index([branchCode]) // Filter by branch
  @@index([customerBankId, status]) // Composite: bank + status
  @@index([pengelolaId, status]) // Composite: pengelola + status
  @@index([createdAt]) // Sorting by date
  @@index([serialNumberManufacturer]) // Search by serial number
  @@index([machineCode]) // Search by machine code
  @@map("machines")
}

model MachineIdentifierHistory {
  id             String         @id @default(uuid()) @db.Char(36)
  machineId      String         @map("machine_id") @db.Char(36)
  identifierType IdentifierType @map("identifier_type")
  oldValue       String?        @map("old_value") @db.VarChar(255)
  newValue       String         @map("new_value") @db.VarChar(255)
  changeReason   String?        @map("change_reason")
  changedBy      String         @map("changed_by") @db.VarChar(255)
  changedAt      DateTime       @default(now()) @map("changed_at")
  machine        Machine        @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("machine_identifier_history")
}

model CassetteType {
  id          String           @id @default(uuid()) @db.Char(36)
  typeCode    CassetteTypeCode @unique @map("type_code")
  machineType String           @map("machine_type") @db.VarChar(100) // SR or VS - machine compatibility
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  cassettes   Cassette[]

  @@map("cassette_types")
}

model Cassette {
  id                    String                 @id @default(uuid()) @db.Char(36)
  serialNumber          String                 @unique @map("serial_number") @db.VarChar(100)
  cassetteTypeId        String                 @map("cassette_type_id") @db.Char(36)
  customerBankId        String                 @map("customer_bank_id") @db.Char(36)
  status                CassetteStatus         @default(OK)
  usageType             CassetteUsageType?     @map("usage_type")
  machineId             String?                @map("machine_id") @db.Char(36)
  notes                 String?
  replacedCassetteId    String?                @map("replaced_cassette_id") @db.Char(36) // NEW: Track replacement - kaset baru menggantikan kaset ini
  replacementTicketId   String?                @map("replacement_ticket_id") @db.Char(36) // NEW: Link to replacement ticket
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  deliveries            CassetteDelivery[]
  returns               CassetteReturn[]
  cassetteType          CassetteType           @relation(fields: [cassetteTypeId], references: [id])
  customerBank          CustomerBank           @relation(fields: [customerBankId], references: [id])
  machine               Machine?               @relation(fields: [machineId], references: [id])
  problemTickets        ProblemTicket[]        @relation("CassetteProblemTickets")
  repairTickets         RepairTicket[]
  ticketCassetteDetails TicketCassetteDetail[] // NEW: Details when included in multi-cassette tickets
  pmCassetteDetails     PMCassetteDetail[] // NEW: Details when included in preventive maintenance
  replacedCassette      Cassette?              @relation("CassetteReplacement", fields: [replacedCassetteId], references: [id]) // NEW: Kaset yang diganti
  replacementFor        Cassette[]             @relation("CassetteReplacement") // NEW: Kaset-kaset yang menggantikan kaset ini
  replacementTicket     ProblemTicket?         @relation("ReplacementTicket", fields: [replacementTicketId], references: [id]) // NEW: Ticket replacement

  // Indexes for performance with large datasets (10k+ cassettes)
  @@index([customerBankId]) // Filter by bank
  @@index([machineId]) // Filter by machine
  @@index([status]) // Filter by status
  @@index([cassetteTypeId]) // Filter by type
  @@index([customerBankId, status]) // Composite: bank + status (for filtering cassettes by bank and status)
  @@index([machineId, status]) // Composite: machine + status
  @@index([createdAt]) // Sorting by date
  @@index([replacedCassetteId]) // NEW: Find replacement cassettes
  @@index([replacementTicketId]) // NEW: Find cassettes by replacement ticket
  @@map("cassettes")
}

model RepairTicket {
  id                String                    @id @default(uuid()) @db.Char(36)
  cassetteId        String                    @map("cassette_id") @db.Char(36)
  reportedIssue     String                    @map("reported_issue")
  receivedAtRc      DateTime                  @map("received_at_rc")
  repairedBy        String?                   @map("repaired_by") @db.Char(36)
  repairActionTaken String?                   @map("repair_action_taken")
  partsReplaced     Json?                     @map("parts_replaced")
  qcPassed          Boolean?                  @map("qc_passed")
  completedAt       DateTime?                 @map("completed_at")
  status            RepairTicketStatus        @default(RECEIVED)
  type              PreventiveMaintenanceType @default(ROUTINE)
  notes             String?
  // Warranty fields
  warrantyType         WarrantyType?          @map("warranty_type")
  warrantyPeriodDays   Int?                   @map("warranty_period_days")
  warrantyStartDate    DateTime?              @map("warranty_start_date")
  warrantyEndDate      DateTime?              @map("warranty_end_date")
  warrantyClaimed      Boolean                @default(false) @map("warranty_claimed")
  warrantyClaimCount   Int                    @default(0) @map("warranty_claim_count")
  isWarrantyRepair     Boolean                @default(false) @map("is_warranty_repair")
  originalRepairId     String?                @map("original_repair_id") @db.Char(36)
  warrantyClaimReason  String?                @map("warranty_claim_reason")
  deletedAt            DateTime?               @map("deleted_at") // Soft delete timestamp
  deletedBy            String?                 @map("deleted_by") @db.Char(36) // User who deleted the repair ticket
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  cassette          Cassette                  @relation(fields: [cassetteId], references: [id])
  repairer          HitachiUser?              @relation(fields: [repairedBy], references: [id])
  originalRepair    RepairTicket?             @relation("WarrantyClaim", fields: [originalRepairId], references: [id])
  warrantyClaims    RepairTicket[]            @relation("WarrantyClaim")
  deleter            HitachiUser?              @relation("RepairTicketDeleter", fields: [deletedBy], references: [id])

  // Indexes for performance
  @@index([cassetteId, status]) // Cassette repair history
  @@index([receivedAtRc]) // Date sorting
  @@index([status]) // Filter by status
  @@index([repairedBy]) // Filter by repairer
  @@index([qcPassed]) // Filter by QC status
  @@index([completedAt]) // Date filtering
  @@index([createdAt]) // Sorting by creation date
  @@index([status, receivedAtRc]) // Composite: status + date
  @@index([warrantyType]) // Filter by warranty type
  @@index([warrantyEndDate]) // Filter by warranty expiration
  @@index([isWarrantyRepair]) // Filter warranty repairs
  @@index([originalRepairId]) // Find warranty claims
  @@index([deletedAt]) // Filter soft-deleted repair tickets
  @@map("repair_tickets")
}

model ProblemTicket {
  id                   String                 @id @default(uuid()) @db.Char(36)
  ticketNumber         String                 @unique @map("ticket_number") @db.VarChar(50)
  cassetteId           String?                @map("cassette_id") @db.Char(36) // Keep for backward compatibility (primary cassette)
  machineId            String?                @map("machine_id") @db.Char(36)
  reportedBy           String                 @map("reported_by") @db.Char(36)
  title                String                 @db.VarChar(255)
  description          String
  priority             ProblemTicketPriority  @default(MEDIUM)
  status               ProblemTicketStatus    @default(OPEN)
  affectedComponents   Json?                  @map("affected_components")
  resolutionNotes      String?                @map("resolution_notes")
  wsid                 String?                @map("wsid") @db.VarChar(100)
  errorCode            String?                @map("error_code") @db.VarChar(50)
  deliveryMethod       String?                @map("delivery_method") @db.VarChar(50)
  courierService       String?                @map("courier_service") @db.VarChar(255)
  trackingNumber       String?                @map("tracking_number") @db.VarChar(100)
  reportedAt           DateTime               @default(now()) @map("reported_at")
  resolvedAt           DateTime?              @map("resolved_at")
  closedAt             DateTime?              @map("closed_at")
  deletedAt            DateTime?              @map("deleted_at") // Soft delete timestamp
  deletedBy            String?                @map("deleted_by") @db.Char(36) // User who deleted the ticket
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  cassetteDelivery     CassetteDelivery?
  cassetteReturn       CassetteReturn?
  cassette             Cassette?              @relation("CassetteProblemTickets", fields: [cassetteId], references: [id])
  machine              Machine?               @relation(fields: [machineId], references: [id])
  reporter             PengelolaUser          @relation(fields: [reportedBy], references: [id])
  cassetteDetails      TicketCassetteDetail[] // NEW: Multiple cassettes per ticket
  replacementCassettes Cassette[]             @relation("ReplacementTicket") // NEW: Cassettes created as replacement

  // Indexes for performance
  @@index([cassetteId, status]) // Check active tickets by cassette
  @@index([machineId, status]) // Machine tickets
  @@index([reportedBy]) // User tickets
  @@index([createdAt]) // Recent tickets
  @@index([status]) // Filter by status
  @@index([reportedAt]) // Date filtering
  @@map("problem_tickets")
}

// NEW MODEL: Junction table untuk detail per cassette dalam 1 ticket
model TicketCassetteDetail {
  id                 String                @id @default(uuid()) @db.Char(36)
  ticketId           String                @map("ticket_id") @db.Char(36)
  cassetteId         String                @map("cassette_id") @db.Char(36)
  title              String                @db.VarChar(255)
  description        String
  priority           ProblemTicketPriority @default(MEDIUM)
  affectedComponents Json?                 @map("affected_components")
  wsid               String?               @map("wsid") @db.VarChar(100)
  errorCode          String?               @map("error_code") @db.VarChar(50)
  requestReplacement Boolean               @default(false) @map("request_replacement")
  replacementReason  String?               @map("replacement_reason")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  ticket             ProblemTicket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  cassette           Cassette              @relation(fields: [cassetteId], references: [id])

  @@unique([ticketId, cassetteId]) // Prevent duplicate cassette in same ticket
  @@index([cassetteId]) // Find tickets by cassette
  @@map("ticket_cassette_details")
}

model CassetteDelivery {
  id                 String        @id @default(uuid()) @db.Char(36)
  ticketId           String        @unique @map("ticket_id") @db.Char(36)
  cassetteId         String        @map("cassette_id") @db.Char(36)
  sentBy             String        @map("sent_by") @db.Char(36)
  shippedDate        DateTime      @map("shipped_date")
  courierService     String?       @map("courier_service") @db.VarChar(255)
  trackingNumber     String?       @map("tracking_number") @db.VarChar(100)
  estimatedArrival   DateTime?     @map("estimated_arrival")
  receivedAtRc       DateTime?     @map("received_at_rc")
  receivedBy         String?       @map("received_by") @db.Char(36)
  notes              String?
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  senderAddress      String?       @map("sender_address")
  senderCity         String?       @map("sender_city") @db.VarChar(100)
  senderContactName  String?       @map("sender_contact_name") @db.VarChar(255)
  senderContactPhone String?       @map("sender_contact_phone") @db.VarChar(50)
  senderPostalCode   String?       @map("sender_postal_code") @db.VarChar(20)
  senderProvince     String?       @map("sender_province") @db.VarChar(100)
  useOfficeAddress   Boolean       @default(false) @map("use_office_address")
  cassette           Cassette      @relation(fields: [cassetteId], references: [id])
  receiver           HitachiUser?  @relation("DeliveryReceiver", fields: [receivedBy], references: [id])
  sender             PengelolaUser @relation(fields: [sentBy], references: [id])
  ticket             ProblemTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("cassette_deliveries")
}

model CassetteReturn {
  id                  String         @id @default(uuid()) @db.Char(36)
  ticketId            String         @unique @map("ticket_id") @db.Char(36)
  cassetteId          String         @map("cassette_id") @db.Char(36)
  sentBy              String         @map("sent_by") @db.Char(36)
  shippedDate         DateTime       @map("shipped_date")
  courierService      String?        @map("courier_service") @db.VarChar(255)
  trackingNumber      String?        @map("tracking_number") @db.VarChar(100)
  estimatedArrival    DateTime?      @map("estimated_arrival")
  receivedAtPengelola DateTime?      @map("received_at_pengelola")
  receivedBy          String?        @map("received_by") @db.Char(36)
  notes               String?
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  cassette            Cassette       @relation(fields: [cassetteId], references: [id])
  receiver            PengelolaUser? @relation("ReturnReceiver", fields: [receivedBy], references: [id])
  sender              HitachiUser    @relation("ReturnSender", fields: [sentBy], references: [id])
  ticket              ProblemTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("cassette_returns")
}

model PreventiveMaintenance {
  id                   String                        @id @default(uuid()) @db.Char(36)
  pmNumber             String                        @unique @map("pm_number") @db.VarChar(50)
  type                 PreventiveMaintenanceType     @default(ROUTINE)
  location             PreventiveMaintenanceLocation @default(PENGELOLA_LOCATION)
  status               PreventiveMaintenanceStatus   @default(SCHEDULED)
  scheduledDate        DateTime                      @map("scheduled_date")
  scheduledTime        String?                       @map("scheduled_time") @db.VarChar(10) // e.g., "09:00-12:00"
  actualStartDate      DateTime?                     @map("actual_start_date")
  actualEndDate        DateTime?                     @map("actual_end_date")
  duration             Int? // Duration in minutes
  title                String                        @db.VarChar(255)
  description          String?
  checklist            Json? // Array of checklist items
  findings             String? // Findings during PM
  actionsTaken         String?                       @map("actions_taken")
  partsReplaced        Json?                         @map("parts_replaced") // Array of parts
  recommendations      String? // Recommendations for next PM
  nextPmDate           DateTime?                     @map("next_pm_date")
  nextPmInterval       Int?                          @map("next_pm_interval") // Days until next PM
  assignedEngineer     String?                       @map("assigned_engineer") @db.Char(36)
  requestedByPengelola String?                       @map("requested_by_pengelola") @db.Char(36)
  requestedByHitachi   String?                       @map("requested_by_hitachi") @db.Char(36)
  requestedByType      String?                       @map("requested_by_type") @db.VarChar(20) // "PENGELOLA" or "HITACHI" or "BANK"
  contactName          String?                       @map("contact_name") @db.VarChar(255)
  contactPhone         String?                       @map("contact_phone") @db.VarChar(50)
  locationAddress      String?                       @map("location_address")
  locationCity         String?                       @map("location_city") @db.VarChar(100)
  locationProvince     String?                       @map("location_province") @db.VarChar(100)
  locationPostalCode   String?                       @map("location_postal_code") @db.VarChar(20)
  notes                String?
  cancelledReason      String?                       @map("cancelled_reason")
  cancelledBy          String?                       @map("cancelled_by") @db.Char(36)
  cancelledAt          DateTime?                     @map("cancelled_at")
  completedBy          String?                       @map("completed_by") @db.Char(36)
  completedAt          DateTime?                     @map("completed_at")
  deletedAt            DateTime?                     @map("deleted_at") // Soft delete timestamp
  deletedBy            String?                       @map("deleted_by") @db.Char(36) // User who deleted the PM
  createdAt            DateTime                      @default(now()) @map("created_at")
  updatedAt            DateTime                      @updatedAt @map("updated_at")
  cassetteDetails      PMCassetteDetail[] // Multiple cassettes per PM
  engineer             HitachiUser?                  @relation("PMEngineer", fields: [assignedEngineer], references: [id])
  requesterPengelola   PengelolaUser?                @relation("PMRequesterPengelola", fields: [requestedByPengelola], references: [id])
  requesterHitachi     HitachiUser?                  @relation("PMRequesterHitachi", fields: [requestedByHitachi], references: [id])
  canceller            HitachiUser?                  @relation("PMCanceller", fields: [cancelledBy], references: [id])
  completer            HitachiUser?                  @relation("PMCompleter", fields: [completedBy], references: [id])
  deleter              HitachiUser?                  @relation("PMDeleter", fields: [deletedBy], references: [id])

  @@index([status]) // Filter by status
  @@index([scheduledDate]) // Date sorting and filtering
  @@index([assignedEngineer]) // Filter by engineer
  @@index([requestedByPengelola]) // Filter by pengelola requester
  @@index([requestedByHitachi]) // Filter by hitachi requester
  @@index([type]) // Filter by PM type
  @@index([location]) // Filter by location
  @@index([status, scheduledDate]) // Composite: status + date
  @@index([createdAt]) // Sorting by creation date
  @@index([pmNumber]) // Search by PM number
  @@index([deletedAt]) // Filter soft-deleted PMs
  @@map("preventive_maintenances")
}

// Junction table untuk multiple cassettes dalam 1 PM
model PMCassetteDetail {
  id            String                @id @default(uuid()) @db.Char(36)
  pmId          String                @map("pm_id") @db.Char(36)
  cassetteId    String                @map("cassette_id") @db.Char(36)
  checklist     Json? // Per-cassette checklist
  findings      String? // Per-cassette findings
  actionsTaken  String?               @map("actions_taken") // Per-cassette actions
  partsReplaced Json?                 @map("parts_replaced") // Per-cassette parts
  status        String?               @db.VarChar(50) // "OK", "NEEDS_REPAIR", "REPLACED", etc.
  notes         String?
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  pm            PreventiveMaintenance @relation(fields: [pmId], references: [id], onDelete: Cascade)
  cassette      Cassette              @relation(fields: [cassetteId], references: [id])

  @@unique([pmId, cassetteId]) // Prevent duplicate cassette in same PM
  @@index([cassetteId, status]) // Active PM tasks by cassette
  @@index([pmId]) // PM details lookup
  @@map("pm_cassette_details")
}

enum OrganizationStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MachineStatus {
  OPERATIONAL
  MAINTENANCE
  DECOMMISSIONED
  UNDER_REPAIR
}

enum PengelolaUserRole {
  TECHNICIAN
  SUPERVISOR
  ADMIN
}

enum HitachiUserRole {
  SUPER_ADMIN
  RC_MANAGER
  RC_STAFF
}

enum HitachiUserDepartment {
  MANAGEMENT
  REPAIR_CENTER
  LOGISTICS
}

enum CassetteTypeCode {
  RB
  AB
  URJB
}

enum CassetteStatus {
  OK
  BAD
  IN_TRANSIT_TO_RC
  IN_REPAIR
  IN_TRANSIT_TO_PENGELOLA
  SCRAPPED
}

enum CassetteUsageType {
  MAIN
  BACKUP
}

enum RepairTicketStatus {
  RECEIVED
  DIAGNOSING
  ON_PROGRESS
  COMPLETED
  SCRAPPED
}

enum ProblemTicketStatus {
  OPEN
  IN_DELIVERY
  RECEIVED
  IN_PROGRESS
  RESOLVED
  RETURN_SHIPPED
  CLOSED
}

enum ProblemTicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IdentifierType {
  WSID
  SERIAL_NUMBER
  BRANCH_CODE
  PENGELOLA_ASSIGNMENT
}

enum PreventiveMaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum PreventiveMaintenanceType {
  ROUTINE
  ON_DEMAND_PENGELOLA
  ON_DEMAND_HITACHI
  EMERGENCY
}

enum PreventiveMaintenanceLocation {
  BANK_LOCATION
  PENGELOLA_LOCATION
  REPAIR_CENTER
}

enum WarrantyType {
  MA
  MS
  IN_WARRANTY
  OUT_WARRANTY
}

// Security: Refresh Token for JWT session management
model RefreshToken {
  id        String   @id @default(uuid()) @db.Char(36)
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id") @db.Char(36)
  userType  String   @map("user_type") @db.VarChar(50) // 'HITACHI' or 'PENGELOLA'
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, userType])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model WarrantyConfiguration {
  id                    String        @id @default(uuid()) @db.Char(36)
  customerBankId        String        @map("customer_bank_id") @db.Char(36)
  warrantyType          WarrantyType  @map("warranty_type")
  
  // Konfigurasi periode garansi (dalam hari)
  warrantyPeriodDays    Int           @map("warranty_period_days") // Default: 30, 60, 90, dll
  maxWarrantyClaims      Int?          @default(1) @map("max_warranty_claims") // Maksimal claim per repair (null jika unlimited)
  unlimitedClaims        Boolean       @default(false) @map("unlimited_claims") // Unlimited claims selama warranty aktif
  warrantyExtensionDays Int?          @map("warranty_extension_days") // Extension jika claim garansi
  
  // Kondisi khusus
  requiresApproval      Boolean       @default(false) @map("requires_approval") // Perlu approval untuk claim
  autoApproveFirstClaim Boolean       @default(true) @map("auto_approve_first_claim")
  freeRepairOnWarranty  Boolean       @default(false) @map("free_repair_on_warranty") // Repair gratis jika dalam garansi
  
  // Notes dan metadata
  notes                 String?
  isActive              Boolean       @default(true) @map("is_active")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  
  customerBank          CustomerBank  @relation(fields: [customerBankId], references: [id], onDelete: Cascade)
  
  @@unique([customerBankId, warrantyType])
  @@index([customerBankId])
  @@index([warrantyType])
  @@index([isActive])
  @@map("warranty_configurations")
}

