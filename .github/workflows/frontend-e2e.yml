name: Frontend E2E Tests

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  frontend-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: hcm_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    # --- BACKEND SETUP ---
    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm ci

    - name: Setup Database (Migrate & Seed)
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://root:root@127.0.0.1:3306/hcm_test
      run: |
        npm run prisma:migrate:deploy
        npm run prisma:seed

    - name: Start Backend
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://root:root@127.0.0.1:3306/hcm_test
        JWT_SECRET: test_ci_secret
        JWT_REFRESH_SECRET: test_ci_refresh_secret
        NODE_ENV: test
        PORT: 3000
      run: npm run start > backend.log 2>&1 &
      
    - name: Wait for Backend
      run: |
        timeout 60s bash -c 'until curl -s http://localhost:3000/api/health > /dev/null; do sleep 2; done'
      
    # --- FRONTEND SETUP ---
    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Install Playwright Browsers
      working-directory: ./frontend
      run: npx playwright install --with-deps chromium

    - name: Run Playwright Tests
      working-directory: ./frontend
      env:
        NEXT_PUBLIC_API_URL: http://localhost:3000/api/v1
        CI: true
      run: npx playwright test

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 7
